# SYSLOG-NG USAGE

## OVERVIEW - 概览
Syslog-ng (syslog-Next generation) 是syslog的升级版。Syslog_ng state模块用于生成syslog-ng配置。 你可以通过该模块做以下事情：
- 从YAML生成syslog-ng配置；
- 使用非YAML配置；
 -启动、停止或重新加载syslog-ng。

还有一个执行模块，可以检查配置的语法、获取有关syslog-ng的版本和其他信息。

## CONFIGURATION - 配置
用户可以使用[syslog_ng.config](https://docs.saltstack.com/en/latest/ref/states/all/salt.states.syslog_ng.html#salt.states.syslog_ng.config)函数创建syslog-ng配置语句。 它需要一个`name`参数和一个`config`参数。 name参数确定生成的语句的名称，config参数包含已解析的YAML结构。

一个statement可以用以下形式声明（两者都是等效的）：
```yaml
source.s_localhost:
  syslog_ng.config:
    - config:
        - tcp:
          - ip: "127.0.0.1"
          - port: 1233
```
```yaml
s_localhost:
  syslog_ng.config:
    - config:
        source:
          - tcp:
            - ip: "127.0.0.1"
            - port: 1233
```
第一个声明示例称为简洁格式，因为它需要比较少的输入。 用户可以使用列表和词典来指定其配置。 本文档中有更多[最后]（#examples）的例子。

## QUOTATION - 引用
当遇到引号引用的内容时可能会很棘手，但这里有一些规则可以遵循：
- 当一个字符串在生成的配置中形如"字符串"时，它在YAML文档中的样子应该是'"字符串"'这样
- 同样，用户应该在yaml配置中写成"'string'"来在生成的配置中获取到'string'

## Full example - 一个完整的例子
以下配置是一个完整的syslog-ng配置的示例：
```yaml
# Set the location of the configuration file
set_location:
  module.run:
    - name: syslog_ng.set_config_file
    - m_name: "/home/tibi/install/syslog-ng/etc/syslog-ng.conf"

# The syslog-ng and syslog-ng-ctl binaries are here. You needn't use
# this method if these binaries can be found in a directory in your PATH.
set_bin_path:
  module.run:
    - name: syslog_ng.set_binary_path
    - m_name: "/home/tibi/install/syslog-ng/sbin"

# Writes the first lines into the config file, also erases its previous
# content
write_version:
  module.run:
    - name: syslog_ng.write_version
    - m_name: "3.6"

# There is a shorter form to set the above variables
set_variables:
  module.run:
    - name: syslog_ng.set_parameters
    - version: "3.6"
    - binary_path: "/home/tibi/install/syslog-ng/sbin"
    - config_file: "/home/tibi/install/syslog-ng/etc/syslog-ng.conf"


# Some global options
options.global_options:
  syslog_ng.config:
    - config:
        - time_reap: 30
        - mark_freq: 10
        - keep_hostname: "yes"

source.s_localhost:
  syslog_ng.config:
    - config:
        - tcp:
          - ip: "127.0.0.1"
          - port: 1233

destination.d_log_server:
  syslog_ng.config:
    - config:
        - tcp:
          - "127.0.0.1"
          - port: 1234

log.l_log_to_central_server:
  syslog_ng.config:
    - config:
        - source: s_localhost
        - destination: d_log_server

some_comment:
  module.run:
    - name: syslog_ng.write_config
    - config: |
        # Multi line
        # comment

# Another mode to use comments or existing configuration snippets
config.other_comment_form:
  syslog_ng.config:
    - config: |
        # Multi line
        # comment
```

`syslog_ng.reloaded`函数用于从YAML生成syslog-ng配置。 如果声明语句中（source, destination, parser, etc.）没有name参数，则此函数将使用id作为名称。

执行此示例后，syslog_ng state状态将生成下面这样的文件：
```
#Generated by Salt on 2014-08-18 00:11:11
@version: 3.6

options {
    time_reap(
        30
    );
    mark_freq(
        10
    );
    keep_hostname(
        yes
    );
};


source s_localhost {
    tcp(
        ip(
            127.0.0.1
        ),
        port(
            1233
        )
    );
};


destination d_log_server {
    tcp(
        127.0.0.1,
        port(
            1234
        )
    );
};


log {
    source(
        s_localhost
    );
    destination(
        d_log_server
    );
};


# Multi line
# comment


# Multi line
# comment
```
用户可以使用`config`语句在生成的配置中包含任意文本（请参阅上面的示例）。

## SYSLOG_NG MODULE FUNCTIONS - Syslog_ng模块提供的功能函数
- 你可以使用[syslog_ng.set_binary_path](https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.syslog_ng.html#salt.modules.syslog_ng.set_binary_path)来设置包含`syslog-ng`和`syslog-ng-ctl`二进制文件的目录。 如果此目录位于环境变量PATH中，则无需做此设置。
- 还有一个[syslog_ng.set_config_file](https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.syslog_ng.html#salt.modules.syslog_ng.set_config_file)函数用来设置配置文件的位置。

## EXAMPLES - 示例
### SIMPLE SOURCE
```
source s_tail {
 file(
   "/var/log/apache/access.log",
   follow_freq(1),
   flags(no-parse, validate-utf8)
 );
};
```
```yaml
s_tail:
  # Salt will call the source function of syslog_ng module
  syslog_ng.config:
    - config:
        source:
          - file:
            - file: ''"/var/log/apache/access.log"''
            - follow_freq : 1
            - flags:
              - no-parse
              - validate-utf8
```
或者使用下面这种方式：
```yaml
s_tail:
  syslog_ng.config:
    - config:
        source:
            - file:
              - ''"/var/log/apache/access.log"''
              - follow_freq : 1
              - flags:
                - no-parse
                - validate-utf8
```
或者写成：
```yaml
source.s_tail:
  syslog_ng.config:
    - config:
        - file:
          - ''"/var/log/apache/access.log"''
          - follow_freq : 1
          - flags:
            - no-parse
            - validate-utf8
```

### COMPLEX SOURCE
```
source s_gsoc2014 {
 tcp(
   ip("0.0.0.0"),
   port(1234),
   flags(no-parse)
 );
};
```
```yaml
s_gsoc2014:
  syslog_ng.config:
    - config:
        source:
          - tcp:
            - ip: 0.0.0.0
            - port: 1234
            - flags: no-parse
```

### FILTER
```
filter f_json {
 match(
   "@json:"
 );
};
```
```yaml
f_json:
  syslog_ng.config:
    - config:
        filter:
          - match:
            - ''"@json:"''
```

## TEMPLATE
```
template t_demo_filetemplate {
 template(
   "$ISODATE $HOST $MSG "
 );
 template_escape(
   no
 );
};
```
```yaml
t_demo_filetemplate:
  syslog_ng.config:
    -config:
        template:
          - template:
            - '"$ISODATE $HOST $MSG\n"'
          - template_escape:
            - "no"
```

### REWRITE
```
rewrite r_set_message_to_MESSAGE {
 set(
   "${.json.message}",
   value("$MESSAGE")
 );
};
```
```yaml
r_set_message_to_MESSAGE:
  syslog_ng.config:
    - config:
        rewrite:
          - set:
            - '"${.json.message}"'
            - value : '"$MESSAGE"'
```

### GLOBAL OPTIONS
```
options {
   time_reap(30);
   mark_freq(10);
   keep_hostname(yes);
};
```
```yaml
global_options:
  syslog_ng.config:
    - config:
        options:
          - time_reap: 30
          - mark_freq: 10
          - keep_hostname: "yes"
```

### LOG
```
log {
 source(s_gsoc2014);
 junction {
  channel {
   filter(f_json);
   parser(p_json);
   rewrite(r_set_json_tag);
   rewrite(r_set_message_to_MESSAGE);
   destination {
    file(
      "/tmp/json-input.log",
      template(t_gsoc2014)
    );
   };
   flags(final);
  };
  channel {
   filter(f_not_json);
   parser {
    syslog-parser(

    );
   };
   rewrite(r_set_syslog_tag);
   flags(final);
  };
 };
 destination {
  file(
    "/tmp/all.log",
    template(t_gsoc2014)
  );
 };
};
```
```yaml
l_gsoc2014:
  syslog_ng.config:
    - config:
        log:
          - source: s_gsoc2014
          - junction:
            - channel:
              - filter: f_json
              - parser: p_json
              - rewrite: r_set_json_tag
              - rewrite: r_set_message_to_MESSAGE
              - destination:
                - file:
                  - '"/tmp/json-input.log"'
                  - template: t_gsoc2014
              - flags: final
            - channel:
              - filter: f_not_json
              - parser:
                - syslog-parser: []
              - rewrite: r_set_syslog_tag
              - flags: final
          - destination:
            - file:
              - "/tmp/all.log"
              - template: t_gsoc2014
```
